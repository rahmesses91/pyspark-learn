services:
  spark:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VARIANT: "3.12-bullseye"
    
    container_name: pyspark_dev
    
    volumes:
      # Mounts your current directory to /workspace in the container
      - .:/workspace:cached
    
    # Keeps the container running for devcontainer to attach
    command: /bin/sh -c "while sleep 1000; do :; done"
    
    ports:
      - "4040:4040"   # Spark UI
      - "8888:8888"   # JupyterLab
      - "18080:18080" # Spark History Server
    
    environment:
      - PYSPARK_PYTHON=/usr/local/bin/python
      - PYSPARK_DRIVER_PYTHON=/usr/local/bin/python
      
      # Guardrails: reduce odds of runaway joins in local dev
      # (Container caps are the hard stop; these are Spark-level soft caps)
      - SPARK_DRIVER_MEMORY=2g
      - SPARK_EXECUTOR_MEMORY=2g
    
    mem_limit: 4g
    cpus: 2.0
    
    # Ensures the vscode user has the right permissions if needed
    user: vscode

    env_file:
      - .env

